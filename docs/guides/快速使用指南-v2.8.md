# 琴房预订系统 v2.8 - 快速使用指南

## 新特性速览 🎉

✅ **不再需要 Reqable！** 直接支持 AnyConnect VPN 和校园网
✅ **自动智能检测** 网络环境
✅ **零配置使用** 打开 VPN 就能用

---

## 三种使用场景

### 场景 1：在校园网内 📡

**直接使用，无需任何配置！**

```
1. 连接校园 Wi-Fi
2. 打开程序
3. 开始预订 ✅
```

---

### 场景 2：校园外 + AnyConnect VPN 🔐（推荐）

**步骤：**

```
1. 打开 Cisco AnyConnect
2. 连接到学校 VPN
3. 打开程序
4. 程序自动检测到 VPN
5. 开始预订 ✅
```

**不需要：**
- ❌ 不需要打开 Reqable
- ❌ 不需要配置代理
- ❌ 不需要任何额外设置

---

### 场景 3：使用 Reqable（备选方案）

**如果 VPN 不可用，仍然支持 Reqable：**

```
1. 打开 Reqable（端口 9000）
2. 打开程序
3. 程序自动检测到代理
4. 开始预订 ✅
```

---

## 首次使用

### 1. 配置个人信息

```
点击「设置」按钮
填写：
  - 学号
  - 密码（用于自动登录）
  - 姓名
  - 邮箱
  - 代理：留空（程序会自动检测）
点击「保存」
```

### 2. 自动检测网络

```
在设置对话框中，点击「自动检测」按钮

可能的结果：
✅ 检测到可以直接连接（VPN 或校园网）
✅ 检测到可用代理：127.0.0.1:9000
```

### 3. 设置 Cookie

```
方法 1：自动登录（推荐）
  - 点击「Cookie」→「自动登录」
  - 程序自动填写账号密码并获取 Cookie

方法 2：手动粘贴
  - 浏览器登录学校网站
  - 复制 Cookie
  - 粘贴到程序
```

### 4. 添加预订请求

```
点击「+」添加琴房预订
选择：
  - 琴房
  - 日期
  - 时间段
```

### 5. 开始预订

```
设置预订时间（如 21:00:00）
点击「开始」
等待自动预订 ✅
```

---

## 常见问题快速解决

### ❓ 提示"Cookie 过期"

**解决：**
```
点击「Cookie」→「自动登录」
重新获取 Cookie
```

---

### ❓ 提示"请求失败, 检查网络、代理服务器或 VPN"

**可能原因：**
1. VPN 未连接
2. 不在校园网内
3. 网络不稳定

**解决：**
```
1. 检查 AnyConnect 是否已连接
   - 打开 AnyConnect
   - 查看连接状态

2. 或使用 Reqable
   - 打开 Reqable
   - 重启程序
   - 点击「自动检测」
```

---

### ❓ 自动检测没有反应

**解决：**
```
1. 检查 VPN 连接状态
   cmd 运行：ipconfig /all
   查找 "Cisco AnyConnect" 适配器

2. 手动清空代理设置
   - 打开「设置」
   - 删除 proxies 内容
   - 保存

3. 重启程序
```

---

### ❓ 想切换连接方式

**从 Reqable 切换到 VPN：**
```
1. 关闭 Reqable
2. 打开 AnyConnect 并连接
3. 打开程序「设置」
4. 清空 proxies
5. 点击「自动检测」
6. 保存
```

**从 VPN 切换到 Reqable：**
```
1. 打开 Reqable
2. 打开程序「设置」
3. 点击「自动检测」
4. 会检测到 Reqable（127.0.0.1:9000）
5. 保存
```

---

## 验证连接是否正常

### 方法 1：运行测试脚本

```bash
cd "项目目录"
python test_connection.py
```

**看到这些表示成功：**
```
[OK] https://sts.cuhk.edu.cn
    状态码: 404 或 200
```

### 方法 2：查看启动日志

```
启动程序后，查看控制台输出：

成功示例：
[启动] 检测到可以直接连接到学校网站（校园网内或 AnyConnect VPN 已连接）

或：
[启动] 已自动检测并应用代理: 127.0.0.1:9000
```

---

## 推荐配置

### config.yaml 示例

**使用 VPN 或校园网：**
```yaml
proxies: ""  # 空字符串或完全不设置这一行

user_id: "12XXXXXXX"
user_password: "你的密码"
user_name: "你的姓名"
user_email: "xxx@link.cuhk.edu.cn"
user_phone: "手机号"
theme: "练琴"

requests:
  - place: "MPC327 管弦乐学部琴房（UP）"
    date: "2025-10-25"
    start: "21:00"
    end: "23:00"
```

**使用 Reqable：**
```yaml
proxies: "127.0.0.1:9000"  # 或其他端口

# 其他配置相同...
```

---

## 性能对比

| 连接方式 | 速度 | 稳定性 | 配置难度 |
|---------|-----|-------|---------|
| 校园网直连 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ 零配置 |
| AnyConnect VPN | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ 一键连接 |
| Reqable 代理 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ 需要软件 |

**建议：** 优先使用 VPN，备选 Reqable

---

## 技术说明（高级用户）

### 核心改进

```python
# v2.8 新特性
session.trust_env = False  # 禁用环境变量干扰
proxies = {"http": None, "https": None}  # 明确禁用代理

# 这样 Python 会使用系统路由（包括 VPN 路由）
```

### 检测优先级

```
1. 测试直接连接 → 成功 → 使用直接连接
2. 检测系统代理 → 找到 → 使用系统代理
3. 检测本地代理软件 → 找到 → 使用本地代理
4. 都不行 → 提示用户配置
```

---

## 更新日志

**v2.8（2025-10-24）**
- ✅ 原生支持 AnyConnect VPN
- ✅ 不再需要 Reqable 中转
- ✅ 自动检测校园网
- ✅ 智能连接方式切换
- ✅ 更友好的提示信息

**v2.7**
- 智能代理检测

**v2.6**
- 完全无人值守自动登录

**v2.4**
- 渐进式表单自动化

---

## 获取帮助

如有问题，请查看：
1. 📖 `v2.8更新说明.md` - 详细技术文档
2. 🧪 `test_connection.py` - 连接测试脚本
3. 📋 其他文档文件夹中的说明文件

---

**版本：** v2.8
**更新日期：** 2025-10-24
**快速开始：** 打开 VPN → 启动程序 → 开始预订 ✅
