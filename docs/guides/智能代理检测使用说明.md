# 智能代理自动检测功能使用说明

## 🎯 功能概述

v2.7版本新增**智能代理自动检测**功能，解决了以下痛点：

### 之前的问题
- ✗ 每次使用必须手动开启 Reqable 等代理软件
- ✗ 需要手动输入代理地址
- ✗ 不知道配置对不对，要反复试错
- ✗ Python程序不走VPN流量，必须通过代理转发

### 现在的解决方案
- ✓ **自动检测 AnyConnect VPN连接**，优先使用VPN直连
- ✓ **自动检测系统代理设置**，无需手动配置
- ✓ **自动检测常见代理软件**（Reqable、Clash、V2Ray等）
- ✓ **自动测试可用性**，确保能访问学校网站
- ✓ **启动时自动配置**，无需任何手动操作

---

## 🚀 使用方法

### 方式一：启动时自动检测（推荐）

**完全自动，无需任何操作！**

1. **首次使用**：
   - 打开"设置"，填写学号、密码、姓名、邮箱
   - 代理栏**留空**（不需要填写）
   - 保存

2. **连接VPN或启动代理软件**：
   - **方案A（推荐）**：连接 Cisco AnyConnect VPN
   - **方案B**：启动 Reqable / Clash / V2Ray 等代理软件

3. **启动程序**：
   - 运行 `python GUI.py`
   - 程序会自动检测并配置代理
   - 查看控制台输出的检测结果

**示例输出（AnyConnect VPN）**：
```
[启动] 配置文件中未设置代理，开始自动检测...
[ProxyDetector] 步骤0：检测 AnyConnect VPN...
[ProxyDetector] 检测到 AnyConnect 进程正在运行
[ProxyDetector] AnyConnect 已连接，VPN IP: 10.101.1.134
[ProxyDetector] 测试直接连接...
[ProxyDetector] [OK] 直接连接成功！
[启动] 已自动检测并应用代理: （空 - 直接连接）
```

**示例输出（Reqable代理）**：
```
[启动] 配置文件中未设置代理，开始自动检测...
[ProxyDetector] 步骤1：检查系统代理设置...
[ProxyDetector] 找到系统代理: {'http': 'http://127.0.0.1:9000', ...}
[ProxyDetector] [OK] 系统代理可用！
[启动] 已自动检测并应用代理: 127.0.0.1:9000
```

---

### 方式二：设置中手动触发

1. **打开设置对话框**
2. **点击代理输入框旁边的"自动检测"按钮**
3. **等待几秒**（检测过程需要3-5秒）
4. **查看结果**：
   - 成功：代理地址会自动填入输入框
   - 失败：显示错误提示和建议

---

## 📋 检测优先级

程序按以下顺序检测：

### 1. AnyConnect VPN（最优先）
- 检测 `vpnagent.exe` / `vpnui.exe` 进程
- 检查 Cisco AnyConnect 虚拟网络适配器
- 验证是否分配了VPN IP地址
- 测试能否直接访问学校网站

**如果成功** → 不使用代理，直接通过VPN连接

### 2. 系统代理设置
- 从Windows注册表读取代理配置
- 测试能否通过该代理访问学校网站

**如果成功** → 使用系统代理

### 3. 本地代理软件
检测以下软件是否正在运行：
- Reqable (端口 9000)
- Clash (端口 7890)
- V2Ray (端口 10809)
- SSR (端口 1080)
- Fiddler / Charles (端口 8888)

逐个测试，找到第一个可用的代理。

**如果成功** → 使用该代理

### 4. 无可用配置
提示用户手动配置或检查网络连接。

---

## 🔧 配置文件说明

### config.yaml 中的 proxies 字段

**空字符串或不设置**：
```yaml
proxies: ""
```
表示：使用直接连接（不经过代理），适合 AnyConnect VPN

**IP:端口格式**：
```yaml
proxies: "127.0.0.1:9000"
```
表示：使用该代理服务器

**自动检测会覆盖此字段**（如果配置文件中为空）

---

## 💡 使用场景

### 场景1：在学校宿舍（校园网）
✓ **不需要任何配置**
1. 直接运行程序
2. 程序检测到在校园网内
3. 直接连接学校网站

### 场景2：在家使用 AnyConnect VPN
✓ **只需连接VPN**
1. 打开 Cisco AnyConnect 客户端
2. 连接到学校VPN
3. 运行程序（自动检测VPN并直连）

### 场景3：使用代理软件（Reqable）
✓ **只需启动代理软件**
1. 打开 Reqable 并启动抓包
2. 运行程序（自动检测Reqable代理）

### 场景4：固定代理地址
✓ **一次配置，永久使用**
1. 在设置中手动填写代理地址
2. 保存
3. 以后启动程序都会使用该代理（不再自动检测）

---

## ❓ 常见问题

### Q1: 为什么检测到 AnyConnect 但还是用代理？

**原因**：AnyConnect 可能使用**分流模式**，不是所有流量都走VPN。

**检测过程**：
1. 程序发现 AnyConnect 已连接
2. 尝试直接访问学校网站 → 失败（SSL握手失败）
3. 回退到检测代理软件

**解决方案**：
- 确保 AnyConnect 配置为**全局模式**（所有流量走VPN）
- 或者继续使用代理软件（Reqable）

### Q2: 提示"未检测到任何代理软件"怎么办？

**检查清单**：
1. ✓ AnyConnect VPN 是否已连接？
   ```
   打开 AnyConnect 客户端，查看连接状态
   ```

2. ✓ 代理软件是否正在运行？
   ```
   Win+R → tasklist
   查找 vpnagent.exe / Reqable.exe / clash.exe
   ```

3. ✓ 代理软件的端口是否正确？
   ```
   检查软件设置中的监听端口（通常是9000、7890等）
   ```

### Q3: 自动检测后还是无法访问学校网站？

**调试步骤**：

1. **查看检测日志**（控制台输出）
   ```
   [ProxyDetector] [FAIL] 直接连接失败: ...
   ```

2. **手动测试代理**
   ```python
   python proxy_detector.py
   ```

3. **手动配置代理**
   - 打开"设置"
   - 点击"自动检测"按钮
   - 查看弹窗提示

4. **检查网络连接**
   - 浏览器能否访问 https://booking.cuhk.edu.cn
   - VPN是否正常工作

### Q4: 可以关闭自动检测吗？

**可以**。在设置中手动填写代理地址，程序就不会再自动检测了。

**config.yaml**：
```yaml
proxies: "127.0.0.1:9000"  # 手动配置的代理
```

启动时会显示：
```
[启动] 使用配置文件中的代理: 127.0.0.1:9000
```

### Q5: 检测过程很慢吗？

**通常只需 3-5 秒**

- AnyConnect检测：~1秒
- 系统代理测试：~3秒
- 本地代理检测：~2秒

只在**首次启动**或**配置文件中代理为空时**才会检测。

---

## 🔬 技术细节

### 检测原理

#### 1. AnyConnect VPN 检测
```python
# 检查进程
tasklist | findstr "vpnagent.exe"

# 检查网络适配器
ipconfig /all | findstr "Cisco AnyConnect"

# 检查IP地址
# 如果虚拟适配器有IP地址 → 已连接
```

#### 2. 系统代理检测
```python
# 读取注册表
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings
- ProxyEnable: 1 (启用)
- ProxyServer: "127.0.0.1:9000"
```

#### 3. 端口扫描
```python
# 检测端口是否开放
socket.connect(("127.0.0.1", 9000))
```

#### 4. 可用性测试
```python
# 尝试访问学校网站
requests.get("https://booking.cuhk.edu.cn", proxies=proxy)
# 状态码 200/302/401/403 → 可用
```

### 性能优化

- **超时控制**：每个测试最多 3 秒
- **快速失败**：找到可用配置立即停止
- **缓存结果**：保存到配置文件，下次直接使用

---

## 📊 版本历史

| 版本 | 日期 | 主要功能 |
|------|------|---------|
| v2.7 | 2025-10-24 | 新增智能代理自动检测功能 |
| - | - | 支持 AnyConnect VPN 检测 |
| - | - | 支持系统代理检测 |
| - | - | 支持常见代理软件检测 |
| - | - | 自动测试可用性 |

---

## 🎉 用户反馈

> "事实上我不希望打开 reqable 软件，我希望它能直接走学校vpn（AnyConnect）提供的端口"

✅ **已实现！** 程序现在优先检测 AnyConnect VPN，如果已连接则直接使用VPN，无需启动Reqable。

---

## 📝 开发信息

**功能状态**：✅ 已完成并测试
**测试环境**：
- Windows 10/11
- Cisco AnyConnect VPN
- Reqable 代理软件

**相关文件**：
- `proxy_detector.py` - 代理检测模块
- `GUI.py` - 主程序（集成自动检测）

**使用的Python库**：
- `winreg` - 读取Windows注册表
- `socket` - 端口扫描
- `requests` - HTTP请求测试
- `subprocess` - 执行系统命令

---

**如有问题，请查看控制台输出的检测日志，或在GitHub提Issue。**
