# 修复完成 - AnyConnect VPN 直接连接问题

## 问题

你报告的问题：即使 AnyConnect VPN 已连接，浏览器可以访问学校网站，但程序自动登录窗口仍显示"chrome-error://chromewebdata/"错误。

## 根本原因

QWebEngineView（自动登录窗口）的代理设置未正确处理。当 `proxies` 为空时，代码直接返回，没有明确禁用代理，导致继承了系统代理设置或之前的代理配置。

## 已完成的修复

### 修改文件：`GUI.py`

**修改位置：** 第 928-966 行，`_apply_proxy()` 方法

**关键改动：**
```python
# 修复前：
if not proxies_config:
    return  # ❌ 问题：没有禁用代理

# 修复后：
if not proxies_config or not proxies_config.strip():
    proxy = QtNetwork.QNetworkProxy()
    proxy.setType(QtNetwork.QNetworkProxy.NoProxy)  # ✅ 明确禁用代理
    QtNetwork.QNetworkProxy.setApplicationProxy(proxy)
    print("[AutoLoginDialog] 已设置为直接连接（NoProxy）")
    return
```

### 配置文件：`config.yaml`

已清空 `proxies` 字段：
```yaml
proxies: ''  # 改为空字符串
```

## 立即测试

### 方法 1：快速测试

```bash
cd "你的项目目录"
python GUI.py
```

**观察启动日志：**
```
[启动] 检测到可以直接连接到学校网站（校园网内或 AnyConnect VPN 已连接）
```

**然后：**
1. 点击"Cookie"→"自动登录获取"
2. 观察自动登录窗口状态栏：应该显示"使用直接连接（无代理）"
3. 页面应该正常加载（不再是 chrome-error）

### 方法 2：完整测试

运行测试脚本：
```bash
python test_qt_proxy.py
```

应该看到：
```
[OK] 已设置 NoProxy
[OK] 验证成功：当前为直接连接模式
```

## 预期结果

### ✅ 成功标志

1. **自动登录窗口正常加载**
   - URL 显示为 `https://booking.cuhk.edu.cn/...`
   - 状态栏显示"使用直接连接（无代理）"

2. **控制台日志正确**
   - `[AutoLoginDialog] 已设置为直接连接（NoProxy）`
   - 没有 chrome-error 错误

3. **自动登录成功**
   - 自动填写学号和密码
   - 成功捕获 Cookie

## 如果仍有问题

### 检查清单

1. ✅ AnyConnect VPN 已连接
   ```bash
   ipconfig /all | findstr "Cisco AnyConnect"
   ```

2. ✅ 配置文件已清空 proxies
   ```yaml
   proxies: ''
   ```

3. ✅ GUI.py 已更新到最新版本

4. ✅ 完全重启程序（不是刷新）

### 临时回滚方案

如果修复后仍有问题，可以临时使用 Reqable：

```yaml
# config.yaml
proxies: "127.0.0.1:9000"
```

然后启动 Reqable，重启程序。

## 技术说明

**为什么需要明确设置 NoProxy？**

`QtNetwork.QNetworkProxy.setApplicationProxy()` 设置的是全局代理，如果不明确清除，之前的设置会一直生效。即使传入空字符串也不会自动清除。

**修复原理：**
```python
# 当 proxies 为空时
proxy = QtNetwork.QNetworkProxy()
proxy.setType(QtNetwork.QNetworkProxy.NoProxy)  # 明确设置为无代理
QtNetwork.QNetworkProxy.setApplicationProxy(proxy)  # 应用到全局
```

这样 QWebEngineView 会使用系统默认路由（包括 VPN 路由），而不是尝试连接不存在的代理。

## 文档

详细技术文档：
- 📖 `Bug修复说明-QWebEngineView代理.md` - 完整测试步骤
- 📖 `v2.8更新说明.md` - 原始功能说明

## 版本

- **修复版本：** v2.8.1
- **修复日期：** 2025-10-24
- **修复内容：** QWebEngineView 代理设置问题

---

**现在可以开始测试了！** 🚀

如有问题，请查看控制台日志并反馈。
