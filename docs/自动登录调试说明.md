# 自动登录功能调试说明

## ✅ 最新更新（v2.4 - 支持渐进式表单）

### 🎯 问题已解决：支持多步骤登录流程

根据用户反馈，CUHK预订系统使用**渐进式登录表单**：
1. 页面加载后需要先点击"Login"按钮
2. 出现学号输入框，填写学号
3. 点击"下一步"或按回车
4. 出现密码输入框，填写密码
5. 点击最终的"登录"按钮

**现在已完全支持这种流程！**

### 🔄 自动化流程

程序会自动执行以下步骤：

**步骤1：查找并点击"Login"按钮**
```
[AutoLogin] Step 1: Looking for Login button...
[AutoLogin] Found Login button, clicking...
状态栏：已点击Login按钮，等待表单加载...
```

**步骤2：填写学号**
```
[AutoLogin] Step 2: Filling username only...
[AutoLogin] Found next button: "login", clicking...
状态栏：已填写学号，等待密码框出现...
```

**步骤3：填写密码并登录**
```
[AutoLogin] Step 3: Filling both username and password...
[AutoLogin] Found submit button, clicking...
状态栏：已自动填写并点击登录按钮，请等待...
```

---

## 截图发送方法

### 方法1：保存到文件后告诉我路径

1. 按 **Win + Shift + S** 或使用**截图工具（Snipping Tool）**
2. 保存截图到桌面，例如：`C:\Users\你的用户名\Desktop\screenshot.png`
3. 告诉我文件完整路径，我可以用Read工具查看

### 方法2：直接描述

您也可以直接用文字描述看到的内容，例如：
- 底部状态栏显示的文字
- Console中的 `[AutoLogin]` 日志内容
- 页面上的输入框数量和类型

---

## 使用开发者工具调试

### 步骤1：打开开发者工具

1. 点击"开始"按钮，自动登录窗口出现
2. 点击顶部工具栏的**"开发者工具"**按钮
3. 弹出开发者工具窗口，顶部有黄色提示条

### 步骤2：查看Console日志

在开发者工具窗口中：
1. 切换到 **Console** 标签（如果不在的话）
2. 查找以 `[AutoLogin]` 开头的日志，例如：

```
[AutoLogin] Starting form auto-fill...
[AutoLogin] Found 5 input fields
[AutoLogin] Username field found: true
[AutoLogin] Password field found: false
```

### 步骤3：分析问题

根据日志判断问题：

| 日志内容 | 问题分析 | 解决方案 |
|---------|---------|---------|
| `Found 0 input fields` | 页面加载不完整 | 等待页面完全加载后手动点击刷新 |
| `Username field found: false` | 未找到用户名输入框 | 手动查看页面输入框属性 |
| `Password field found: false` | 未找到密码输入框 | 可能使用了非标准输入控件 |
| `Form filled successfully` | 填写成功但未自动点击 | 手动点击登录按钮即可 |
| `Found login button, clicking...` | 自动化完全成功 | 等待登录完成 |

### 步骤4：手动测试输入框

如果日志显示未找到输入框，在Console中执行：

```javascript
// 查看所有输入框
document.querySelectorAll('input')

// 查看文本输入框
document.querySelectorAll('input[type="text"]')

// 查看密码输入框
document.querySelectorAll('input[type="password"]')

// 查看所有按钮
document.querySelectorAll('button')
```

执行后会返回NodeList，展开可以看到输入框的详细属性。

---

## 问题现象

用户反馈：打开网页出现 Login 按钮后就不动了，未能成功自动登录。

## 已实施的改进（v2.1）

### 1. **增强的表单识别逻辑**

原有代码使用简单的选择器，容易失效。现在采用多级回退策略：

```javascript
// 优先级1：精确匹配（name/id包含user关键字）
input[name*="user"], input[id*="user"]

// 优先级2：模糊匹配（placeholder包含"学号"或"账号"）
input[placeholder*="学号"], input[placeholder*="账号"]

// 优先级3：兜底方案（使用第一个text输入框）
textInputs[0]
```

### 2. **自动点击登录按钮**

改进后会自动查找并点击登录按钮：

```javascript
// 查找策略：
// 1. 标准submit按钮
// 2. 包含"登录"/"Login"文本的按钮
// 3. 常见class/id（.login-btn, #login-btn）

if (loginButton) {
    setTimeout(() => loginButton.click(), 100);
    return 'filled_and_clicked';
}
```

### 3. **增强的事件触发**

填写表单后触发多种事件，确保前端验证生效：

```javascript
['input', 'change', 'blur'].forEach(eventType => {
    usernameField.dispatchEvent(new Event(eventType, { bubbles: true }));
    passwordField.dispatchEvent(new Event(eventType, { bubbles: true }));
});
```

### 4. **多时机触发机制**

- **页面加载完成时**：延迟1秒后尝试填写
- **URL变化时**：延迟1秒后尝试填写（捕捉页面跳转）
- **自动重试**：最多重试3次，每次间隔2秒

### 5. **详细的状态提示**

底部状态栏会显示：
- "页面加载完成，准备自动填写表单..."
- "已自动填写并点击登录按钮，请等待..."
- "已自动填写学号和密码，请点击登录按钮"
- "未找到表单，2秒后重试...（第1/3次）"

### 6. **JavaScript控制台日志**

代码中添加了详细的console.log，可以通过浏览器开发者工具查看：

```javascript
console.log('[AutoLogin] Starting form auto-fill...');
console.log('[AutoLogin] Found ' + allInputs.length + ' input fields');
console.log('[AutoLogin] Username field found: ' + (usernameField !== null));
console.log('[AutoLogin] Password field found: ' + (passwordField !== null));
```

---

## 常见问题排查

### Q1: 状态栏显示"未找到表单"，且重试3次后仍失败

**可能原因：**
- 登录页面使用了iframe
- 页面使用了非标准的输入控件（如自定义组件）
- 页面加载较慢，JavaScript尚未渲染完成

**解决方案：**
1. 点击"开发者工具"按钮，查看Console日志
2. 查看 `Found X input fields` 的数量，如果是0说明页面未加载完成
3. 手动点击"刷新"按钮重新加载页面
4. 如果仍然失败，手动输入学号密码

### Q2: 自动填写成功但未自动点击登录按钮

**可能原因：**
- 登录按钮使用了非标准的HTML元素（如`<a>`或`<div>`伪装的按钮）
- 登录按钮的文本不包含"登录"或"Login"

**解决方案：**
- 手动点击登录按钮即可
- 程序会正常捕获Cookie

### Q3: 点击登录后提示"用户名或密码错误"

**可能原因：**
- 密码填写错误（检查config.yaml中的user_password字段）
- 账号被锁定或需要验证码

**解决方案：**
- 检查"设置"中的学号和密码是否正确
- 手动输入正确的学号密码

### Q4: 开发者工具窗口是空白的

**可能原因：**
- 页面尚未加载完成
- 需要刷新一次才能看到Console

**解决方案：**
- 等待主窗口页面加载完成
- 在开发者工具窗口中点击顶部的刷新按钮
- 切换到Console标签

---

## 技术改进记录

| 版本 | 日期 | 改进内容 |
|------|------|----------|
| v2.0 | 2025-10-24 | 初始版本，基础自动填写功能 |
| v2.1 | 2025-10-24 | 增强选择器、自动点击、多时机触发、重试机制 |
| v2.2 | 2025-10-24 | 新增"开发者工具"按钮，一键打开调试控制台 |

---

## 后续优化建议

如果问题仍然存在，可以进一步优化：

1. **添加iframe支持**：检测并在iframe中查找表单
2. **OCR验证码识别**：如果登录需要验证码
3. **自定义选择器配置**：允许用户在config.yaml中配置输入框选择器
4. **录制回放功能**：记录用户的操作步骤，下次自动回放

---

**如有问题，请提供以下信息：**
1. 底部状态栏的最后一条提示信息
2. 开发者工具Console中的 `[AutoLogin]` 日志（截图或文字描述）
3. 登录页面的URL
4. 是否需要验证码
